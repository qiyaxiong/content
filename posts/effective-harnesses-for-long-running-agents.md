---
title: 长期运行代理的有效框架
published: 2025-12-12
description: 探讨如何让AI代理在跨越多个上下文窗口时保持一致性，通过初始化代理和编码代理的两阶段解决方案实现长期运行
tags: [AI代理,上下文]
category: AI工程
draft: false
---
# 长期运行代理的有效框架

## 问题背景

随着AI代理能力的提升，开发者开始让它们承担需要数小时甚至数天才能完成的复杂任务。然而，让代理在多个上下文窗口之间保持一致的进展仍然是一个开放性问题。

核心挑战在于：代理必须在离散的会话中工作，每个新会话开始时都没有之前会话的记忆。这就像软件项目由轮班工程师完成，但每个新工程师到达时都没有上一班次的记忆。

## 解决方案：两阶段方法

为了解决这个问题，研究团队开发了一个两阶段的解决方案：

### 1. 初始化代理（Initializer Agent）

第一个代理会话使用专门的提示，要求模型设置初始环境：

- 创建 `init.sh` 脚本
- 创建 `claude-progress.txt` 文件记录代理工作日志
- 创建初始 git 提交，显示添加的文件

### 2. 编码代理（Coding Agent）

每个后续会话要求模型：

- 做出增量进展
- 留下结构化的更新

关键洞察是找到一种方法让代理在开始新的上下文窗口时快速理解工作状态，这通过 `claude-progress.txt` 文件和 git 历史记录来实现。

## 环境管理的关键组件

### 功能列表（Feature List）

为了解决代理一次性完成应用或过早认为项目完成的问题，初始化代理被要求编写一个全面的功能需求文件，扩展用户的初始提示。例如，在 claude.ai 克隆示例中，这意味着超过200个功能。

这些功能最初都标记为"失败"，以便后续的编码代理能够清楚地了解完整功能的样子。使用 JSON 格式，因为模型不太可能不适当地更改或覆盖 JSON 文件。

### 增量进度

编码代理被要求一次只处理一个功能。这种增量方法对于解决代理一次做太多事情的倾向至关重要。

即使采用增量方法，模型在做出代码更改后仍需要将环境保持在干净状态。最佳方式是要求模型：

- 使用描述性的提交消息将进度提交到 git
- 在进度文件中编写进度摘要

这允许模型使用 git 来恢复错误的代码更改并恢复代码库的工作状态。

### 测试

一个主要的失败模式是 Claude 倾向于在没有适当测试的情况下将功能标记为完成。通过明确提示，Claude 在提供浏览器自动化工具时表现更好，能够像人类用户一样进行端到端测试。

## 快速上手流程

每个编码代理被提示运行一系列步骤来了解情况：

1. 运行 `pwd` 查看工作目录
2. 阅读 git 日志和进度文件，了解最近的工作
3. 阅读功能列表文件，选择尚未完成的最高优先级功能

典型的会话开始时，代理会：

- 检查当前项目状态
- 阅读进度文件
- 查看 git 日志
- 运行 `init.sh` 重启开发服务器
- 验证基本功能是否仍然工作
- 然后开始处理新功能

## 失败模式和解决方案

| 问题                                  | 初始化代理行为                        | 编码代理行为                                                                             |
| ------------------------------------- | ------------------------------------- | ---------------------------------------------------------------------------------------- |
| Claude 过早宣布整个项目完成           | 设置功能列表文件                      | 在会话开始时阅读功能列表文件，选择单个功能开始工作                                       |
| Claude 留下有错误或未记录进度的环境   | 编写初始 git 仓库和进度注释文件       | 在会话开始时阅读进度注释文件和 git 提交日志，运行基本测试；结束时编写 git 提交和进度更新 |
| Claude 过早标记功能为完成             | 设置功能列表文件                      | 自我验证所有功能，只有在仔细测试后才将功能标记为"通过"                                   |
| Claude 需要花费时间弄清楚如何运行应用 | 编写可以运行开发服务器的 init.sh 脚本 | 在会话开始时阅读 init.sh                                                                 |

## 未来工作

这项研究展示了一种可能的长期运行代理框架解决方案，使模型能够在多个上下文窗口之间取得增量进展。但仍存在开放性问题：

- 单一通用编码代理是否在所有上下文中表现最佳，还是多代理架构可以实现更好的性能？
- 专门的代理（如测试代理、质量保证代理或代码清理代理）是否能在软件开发生命周期的子任务中做得更好？
- 如何将这些发现推广到其他领域，如科学研究或金融建模？

## 总结

通过借鉴人类软件工程师的日常实践，研究团队开发了一个有效的框架，使AI代理能够在长期运行的任务中保持一致性。关键在于：

- 清晰的初始环境设置
- 结构化的进度跟踪
- 增量式的工作方法
- 严格的测试验证

这些方法显著提高了代理在跨多个上下文窗口工作时的效率和可靠性。
